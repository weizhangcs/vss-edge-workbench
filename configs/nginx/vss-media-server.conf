# 文件路径: configs/nginx/vss-media-server.conf
# VSS Edge Media Server - Production Optimized V2

server {
    listen 80;
    server_name localhost;

    # --- [全局核心优化] ---
    # 允许上传的最大文件大小 (针对 batch_uploads)
    # 设置为 0 表示不限制，或者设置为具体值如 20G
    client_max_body_size 20G;

    # 开启零拷贝：极大降低大文件发送时的 CPU 消耗
    sendfile on;
    # 减少网络报文数量
    tcp_nopush on;
    # 禁用 Nagle 算法，降低延迟 (对视频拖拽至关重要)
    tcp_nodelay on;
    # 保持长连接
    keepalive_timeout 65;

    # --- [1. 标注产物 (Annotation Media)] ---
    # 特性: 频繁修改的 JSON/ASS 文件
    # 策略: 禁用强缓存，强制验证
    location /media/annotation/ {
        alias /var/www/media_root/annotation/;

        # 允许跨域 (Label Studio/Subeditor 需要)
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range' always;

        if ($request_method = 'OPTIONS') { return 204; }

        # [关键修正] 禁用缓存！防止标注数据更新后前端不刷新
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        expires -1;
    }

    # --- [2. 静态资源 (Static Files)] ---
    # 特性: Django 系统资源，部署后基本不变
    location /static/ {
        alias /var/www/staticfiles/;

        # 激进缓存 30天
        expires 30d;
        add_header Cache-Control "public";

        # 关闭日志，减少磁盘 IO
        access_log off;

        add_header 'Access-Control-Allow-Origin' '*' always;
    }

    # --- [3. 视频媒资 (Video Assets)] ---
    # 覆盖: batch_uploads, source_files, transcoding_outputs, creative
    # 特性: 大文件，写入后基本不修改，需要高效分发
    location /media/ {
        alias /var/www/media_root/;

        # [核心] 视频严禁 Gzip，否则无法分片传输
        gzip off;

        # [核心] 强制支持断点续传/范围请求 (支持视频拖拽)
        add_header Accept-Ranges bytes;

        # 视频文件设置最大缓存
        expires max;
        add_header Cache-Control "public, no-transform";

        # 跨域设置
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range' always;
        # 暴露 Content-Range 头给播放器
        add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;

        if ($request_method = 'OPTIONS') { return 204; }
    }
}