{% extends "admin/change_form.html" %}
{% load i18n admin_urls static %}

{% block after_field_sets %}

{# 1. æ•°æ®æ„é€ : å°† Django å¯¹è±¡è½¬ä¸º JSON #}
<script>
    window.SERVER_CONTEXT = {
        // çŠ¶æ€é€‰é¡¹
        statusOptions: [
            {% for s, d in status_choices %}["{{ s }}", "{{ d }}"],{% endfor %}
        ],
        // å½“å‰è¿‡æ»¤å™¨
        filter: {
            active: "{{ l1_active_filter|default:'' }}"
        },
        // åˆ†é¡µä¿¡æ¯
        pagination: {
            current: {{ l1_page_obj.number }},
            total: {{ l1_page_obj.paginator.count }},
            pageSize: 10, // ä¸åç«¯ Paginator ä¿æŒä¸€è‡´
            totalPages: {{ l1_page_obj.paginator.num_pages }}
        },
        // è¡¨æ ¼æ•°æ®åˆ—è¡¨
        items: [
            {% for item in l1_media_items_with_status %}
            {
                "id": "{{ item.media.id }}",
                "sequence": "{{ item.media.sequence_number }}",
                "title": "{{ item.media.title|escapejs }}",
                "status": "{% if item.l1_job %}{{ item.l1_job.status }}{% else %}NOT_CREATED{% endif %}",
                "statusDisplay": "{% if item.l1_job %}{{ item.l1_job.get_status_display }}{% else %}æœªåˆ›å»º{% endif %}",
                "created": "{% if item.l1_job %}{{ item.l1_job.created|date:'Y-m-d H:i' }}{% else %}--{% endif %}",
                "modified": "{% if item.l1_job %}{{ item.l1_job.modified|date:'Y-m-d H:i' }}{% else %}--{% endif %}",
                // æ“ä½œæŒ‰é’®é€»è¾‘
                "actionUrl": "{% if item.l1_job %}{% if item.l1_job.l1_output_file %}{% url 'workflow:annotation_job_revise_l1' item.l1_job.id %}{% else %}{% url 'workflow:annotation_job_start_l1' item.l1_job.id %}{% endif %}{% endif %}",
                "actionText": "{% if item.l1_job and item.l1_job.l1_output_file %}ğŸ” ä¿®è®¢è§’è‰²æ ‡æ³¨{% else %}â–¶ï¸ å¼€å§‹è§’è‰²æ ‡æ³¨{% endif %}",
                "isRevision": {% if item.l1_job and item.l1_job.l1_output_file %}true{% else %}false{% endif %}
            },
            {% endfor %}
        ]
    };
</script>

{# 2. æŒ‚è½½ç‚¹ #}
<div id="react-root-l1" class="mt-6 bg-white min-h-[400px]">
    <div class="text-center pt-20">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
    </div>
</div>

{# 3. å¼•ç”¨ JS (è®°å¾—åŠ ä¸Š type="module") #}
<script type="module" src="{% static 'js/bundles/annotation-character.js' %}"></script>

{% endblock %}