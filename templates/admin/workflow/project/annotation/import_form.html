{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{# --- 1. 资源加载区 --- #}
{% block extrahead %}
    {{ block.super }}
    <script src="{% static 'creative/js/libs/react.production.min.js' %}"></script>
    <script src="{% static 'creative/js/libs/react-dom.production.min.js' %}"></script>
    <script src="{% static 'creative/js/libs/dayjs.min.js' %}"></script>
    <script src="{% static 'creative/js/libs/antd.min.js' %}"></script>
    <script src="{% static 'creative/js/libs/babel.min.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ant-design-icons/4.7.0/index.umd.min.js"></script>

    <link rel="stylesheet" href="{% static 'creative/css/factory.css' %}">
    <style>
        #content { padding: 0 !important; margin: 0 !important; }
        /* [修改点] 这里的 CSS 也要同步改为浅紫色背景和紫色虚线边框 */
        .ant-upload-drag { background-color: #faf5ff !important; border: 1px dashed #d8b4fe !important; }
        .ant-upload-drag:hover { border-color: #9333ea !important; }
    </style>
{% endblock %}

{% block content %}

{# --- 2. 数据注入区 --- #}
<script>
    window.DJANGO_URLS = {
        changelist: "{% url 'admin:workflow_annotationproject_changelist' %}"
    };
</script>

<script id="asset-data" type="application/json">
[
    {% for asset in form.fields.target_asset.queryset %}
    { "value": "{{ asset.id }}", "label": "{{ asset.title }} ({{ asset.created|date:'Y-m-d' }})" }{% if not forloop.last %},{% endif %}
    {% endfor %}
]
</script>

{# --- 3. React 挂载点 --- #}
<div id="react-root" class="bg-white min-h-screen p-6">
    <div class="text-center pt-20">
        <span class="text-gray-400">正在加载导入组件...</span>
    </div>
</div>

{# --- 4. React 业务代码 --- #}
{% verbatim %}
<script type="text/babel">
    const { useState, useMemo } = React;
    const { Steps, Upload, Select, Alert, Button, Typography, Card, message, ConfigProvider } = window.antd;
    const { FolderOpenOutlined, InboxOutlined, SearchOutlined, InfoCircleOutlined } = window.icons;

    const { Title, Text } = Typography;
    const { Dragger } = Upload;

    // [修改点] 定义 Unfold 风格的紫色主题变量
    const THEME_COLOR = {
        primary: '#9333ea',    // 主色 (Purple-600)
        lightBg: '#faf5ff',    // 浅色背景 (Purple-50)
        border: '#d8b4fe',     // 边框色 (Purple-300)
    };

    const ImportAnnotationProject = () => {
        const assetOptions = useMemo(() => {
            try {
                return JSON.parse(document.getElementById('asset-data').textContent);
            } catch (e) {
                return [];
            }
        }, []);

        const [fileList, setFileList] = useState([]);
        const [targetAssetId, setTargetAssetId] = useState(null);
        const [submitting, setSubmitting] = useState(false);

        const uploadProps = {
            name: 'zip_file',
            multiple: false,
            fileList: fileList,
            accept: '.zip',
            beforeUpload: (file) => {
                setFileList([file]);
                return false;
            },
            onRemove: () => {
                setFileList([]);
            }
        };

        const handleSubmit = async () => {
            if (fileList.length === 0) {
                message.error('请先上传项目压缩包！');
                return;
            }
            if (!targetAssetId) {
                message.error('请选择关联的媒体资产！');
                return;
            }

            setSubmitting(true);
            const formData = new FormData();
            formData.append('zip_file', fileList[0]);
            formData.append('target_asset', targetAssetId);
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
            formData.append('csrfmiddlewaretoken', csrfToken);

            try {
                const response = await fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });

                if (response.redirected) {
                    message.success('导入成功！正在跳转...', 1.5, () => {
                        window.location.href = response.url;
                    });
                } else if (!response.ok) {
                    message.error('导入失败，请检查文件格式或重试。');
                    setSubmitting(false);
                } else {
                     message.success('导入处理完成', 1.5, () => {
                        window.location.href = window.DJANGO_URLS.changelist;
                    });
                }
            } catch (error) {
                console.error(error);
                message.error('网络请求错误');
                setSubmitting(false);
            }
        };

        const stepItems = [
            { title: '上传文件', status: fileList.length > 0 ? 'finish' : 'process' },
            { title: '关联资产', status: targetAssetId ? 'finish' : 'wait' },
            { title: '开始恢复', status: 'wait' },
        ];

        return (
            <div className="flex justify-center items-start pt-4">
                <Card
                    bordered={false}
                    className="w-full max-w-[900px] shadow-none"
                    bodyStyle={{ padding: 0 }}
                >
                    {/* Header Region */}
                    <div style={{ padding: '32px 0', backgroundColor: '#fff' }}>
                        <div className="flex items-start" style={{ marginBottom: '32px' }}>
                            {/* [修改点] 图标颜色改为紫色 */}
                            <FolderOpenOutlined style={{ fontSize: '36px', color: THEME_COLOR.primary, marginRight: '20px', marginTop: '4px' }} />
                            <div>
                                <Title level={3} style={{ margin: 0, fontWeight: 'bold', fontSize: '24px' }}>
                                    导入标注项目
                                </Title>
                                <Text type="secondary" style={{ fontSize: '14px' }}>
                                    上传 ZIP 文件以恢复标注数据，并自动关联到媒体资产库。
                                </Text>
                            </div>
                        </div>
                        <div style={{ padding: '0 10px' }}>
                            <Steps current={fileList.length > 0 ? (targetAssetId ? 2 : 1) : 0} items={stepItems} size="small" />
                        </div>
                    </div>

                    {/* Body Region */}
                    <div style={{ padding: '0', backgroundColor: '#fff' }}>
                        <section style={{ marginBottom: '40px' }}>
                            <h3 style={{ fontSize: '16px', fontWeight: 600, marginBottom: '16px', color: '#374151' }}>
                                步骤 1：上传项目数据包
                            </h3>
                            {/* [修改点] Dragger 样式改为紫色系背景和边框 */}
                            <Dragger {...uploadProps} style={{ padding: '40px 0', backgroundColor: THEME_COLOR.lightBg, border: `1px dashed ${THEME_COLOR.border}` }}>
                                <p className="ant-upload-drag-icon">
                                    {/* [修改点] 拖拽图标颜色 */}
                                    <InboxOutlined style={{ color: THEME_COLOR.primary, fontSize: '48px' }} />
                                </p>
                                <p className="ant-upload-text" style={{ fontSize: '16px', fontWeight: 500, color: '#1f2937' }}>
                                    点击或拖拽文件到此处上传
                                </p>
                                <p className="ant-upload-hint" style={{ color: '#6b7280' }}>
                                    支持格式: .zip (需包含 manifest.json)
                                </p>
                            </Dragger>
                        </section>

                        <section>
                            <h3 style={{ fontSize: '16px', fontWeight: 600, marginBottom: '16px', color: '#374151' }}>
                                步骤 2：选择目标媒体资产
                            </h3>
                            <Select
                                showSearch
                                placeholder="请选择或搜索要关联的媒体资产..."
                                optionFilterProp="children"
                                size="large"
                                style={{ width: '100%' }}
                                onChange={(value) => setTargetAssetId(value)}
                                filterOption={(input, option) =>
                                    (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                                }
                                options={assetOptions}
                            />

                            <Alert
                                style={{ marginTop: '24px', borderRadius: '8px' }}
                                message={<span style={{ fontWeight: 600 }}>关联匹配逻辑说明</span>}
                                description={
                                    <span style={{ color: '#4b5563' }}>
                                        系统将根据 <b>媒体文件序号 (Sequence)</b> 自动匹配并导入数据。请确保所选资产包含对应的媒体文件（如 EP01, EP02...）。若找不到对应序号，相关数据将被跳过。
                                    </span>
                                }
                                type="info"
                                showIcon
                                icon={<InfoCircleOutlined />}
                            />
                        </section>
                    </div>

                    {/* Footer Region */}
                    <div style={{ padding: '40px 0', backgroundColor: '#fff', borderTop: 'none', display: 'flex', justifyContent: 'flex-start', gap: '12px' }}>
                         <Button
                            type="primary"
                            size="large"
                            onClick={handleSubmit}
                            loading={submitting}
                            disabled={!fileList.length || !targetAssetId}
                            style={{ minWidth: '160px' }}
                        >
                            {submitting ? '正在恢复数据...' : '确认并开始导入'}
                        </Button>
                        <Button size="large" onClick={() => window.history.back()}>
                            取消
                        </Button>
                    </div>
                </Card>
            </div>
        );
    };

    const rootNode = document.getElementById('react-root');
    if (rootNode) {
        const root = ReactDOM.createRoot(rootNode);
        // [修改点] 使用 ConfigProvider 包裹应用，设置全局紫色主题
        root.render(
            <ConfigProvider theme={{ token: { colorPrimary: '#9333ea' } }}>
                <ImportAnnotationProject />
            </ConfigProvider>
        );
    }
</script>
{% endverbatim %}

<div style="display:none">
    {% csrf_token %}
</div>
{% endblock %}