{% extends "admin/base.html" %}
{% load i18n admin_urls unfold %}

{% block content %}
<div class="p-8">
    {# --- 1. 面包屑导航 (来自您的原文件) --- #}
    <nav class="flex mb-4" aria-label="Breadcrumb">
        <ol role="list" class="flex items-center space-x-4">
            <li>
                <div>
                    <a href="{% url 'admin:index' %}" class="text-gray-400 hover:text-gray-500">
                        <svg class="h-5 w-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M9.293 2.293a1 1 0 011.414 0l7 7A1 1 0 0117 11h-1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-3a1 1 0 00-1-1H9a1 1 0 00-1 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-6H3a1 1 0 01-.707-1.707l7-7z" clip-rule="evenodd" /></svg>
                        <span class="sr-only">{% translate 'Home' %}</span>
                    </a>
                </div>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="h-5 w-5 flex-shrink-0 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true"><path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z" /></svg>
                    <a href="{% url 'admin:app_list' app_label=opts.app_label %}" class="ml-4 text-sm font-medium text-gray-500 hover:text-gray-700">{{ opts.app_config.verbose_name }}</a>
                </div>
            </li>
             <li>
                <div class="flex items-center">
                    <svg class="h-5 w-5 flex-shrink-0 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true"><path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z" /></svg>
                    <a href="{% url opts|admin_urlname:'changelist' %}" class="ml-4 text-sm font-medium text-gray-500 hover:text-gray-700">{{ opts.verbose_name_plural|capfirst }}</a>
                </div>
            </li>
             <li>
                <div class="flex items-center">
                    <svg class="h-5 w-5 flex-shrink-0 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true"><path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z" /></svg>
                    <a href="{% url opts|admin_urlname:'change' original.pk|admin_urlquote %}" class="ml-4 text-sm font-medium text-gray-500 hover:text-gray-700">{{ original|truncatewords:"18" }}</a>
                </div>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="h-5 w-5 flex-shrink-0 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true"><path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z" /></svg>
                    <span class="ml-4 text-sm font-medium text-gray-500">{{ title }}</span>
                </div>
            </li>
        </ol>
    </nav>

    <h1 class="text-2xl font-semibold text-gray-900 mt-2 mb-6">{{ title }}</h1>

    <fieldset class="module aligned">
        <div class="p-4 border rounded-md shadow-sm bg-white">

          {% with project=original %}

            {# --- 状态 1: PENDING (等待启动) --- #}
            {% if project.cloud_reasoning_status == 'PENDING' and project.final_blueprint_file %}
              <div class="p-4 bg-gray-50 rounded-lg border">
                <h3 class="font-semibold text-lg mb-3">启动云端推理</h3>
                <p class="mb-4 text-sm text-gray-700">叙事蓝图已生成。请选择一种模式启动云端推理工作流。</p>

                {# [FIXED] 修复了模式 B 的表单 #}
                <div class="mb-4 border-b pb-4">
                  <h4 class="font-medium text-md mb-2">模式 B：自动流水线 (推荐)</h4>
                  <p class="text-sm mb-3 text-gray-600">
                    此模式将自动分析角色矩阵，选择 Top N 个角色，然后识别属性并部署知识图谱。
                  </p>
                  <form action="{% url 'workflow:annotation_project_trigger_cloud_pipeline' project.pk %}" method="POST" class="flex items-center space-x-2">
                    {% csrf_token %}
                    <label for="top_n_input" class="text-sm font-medium">Top N 角色:</label>
                    <input type="number" name="top_n" id="top_n_input" value="3" class="w-20 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <button type="submit" class="button variant-primary">
                      启动自动流水线 (模式 B)
                    </button>
                  </form>
                </div>

                {# 模式 A 的表单 #}
                <div>
                  <h4 class="font-medium text-md mb-2">模式 A：手动选择角色</h4>
                  <p class="text-sm mb-3 text-gray-600">
                    此模式将先分析角色矩阵，然后暂停，等待您手动选择角色后再继续。
                  </p>
                  <form action="{% url 'workflow:annotation_project_trigger_cloud_metrics' project.pk %}" method="POST">
                    {% csrf_token %}
                    <button type="submit" class="button variant-default">
                      1. 开始分析角色矩阵 (模式 A)
                    </button>
                  </form>
                </div>
              </div>

            {# --- 状态 2: WAITING_FOR_SELECTION (等待用户输入) --- #}
            {# [FIXED] 修复了导致崩溃的 for / elif 语法错误 #}
            {% elif project.cloud_reasoning_status == 'WAITING_FOR_SELECTION' %}
              <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-300">
                <h3 class="font-semibold text-lg mb-3 text-yellow-800">⏸️ 需要您操作</h3>
                <p class="mb-4 text-sm text-yellow-700">“角色矩阵”分析已完成。请从下方选择要继续分析的角色，然后点击“继续”。</p>

                {% if character_selection_form %}
                  <form action="{% url 'workflow:annotation_project_trigger_cloud_facts' project.pk %}" method="POST">
                    {% csrf_token %}

                    <div class="mb-4">
                      <label class="block text-sm font-medium text-gray-700 mb-2">
                        {{ character_selection_form.characters.label }}:
                      </label>
                      <div class="mt-2 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3">

                        {# [FIXED] 渲染 Checkbox 列表 #}
                        {% for checkbox in character_selection_form.characters %}
                           <label for="{{ checkbox.id_for_label }}" class="flex items-center space-x-2 p-2 border rounded-md hover:bg-gray-50 cursor-pointer">
                               {{ checkbox.tag }}
                               <span class="font-medium">{{ checkbox.choice_label }}</span>
                           </label>
                        {% endfor %} {# <-- [FIXED] 缺少 endfor #}

                      </div>
                    </div>

                    {# [FIXED] 添加提交按钮和表单结尾 #}
                    <div class="mt-4 border-t pt-4 flex justify-start">
                        <button type="submit" class="button variant-primary">
                          2. 继续识别所选角色属性
                        </button>
                    </div>
                  </form> {# <-- [FIXED] 缺少 form 闭合标签 #}

                {% endif %}
              </div>

            {# --- 状态 3: COMPLETED (已完成) --- #}
            {% elif project.cloud_reasoning_status == 'COMPLETED' %}
              <div class="p-4 bg-green-50 rounded-lg border border-green-300">
                <h3 class="font-semibold text-lg text-green-800 mb-2">✅ 已完成</h3>
                <p class="text-sm text-green-700">云端推理工作流（包括 RAG 部署）已成功完成。</p>
                <p class="text-sm text-gray-600 mt-2">您可以关闭此窗口，返回项目详情页查看产出物。</p>
              </div>

            {# --- 状态 4: FAILED (失败) --- #}
            {% elif project.cloud_reasoning_status == 'FAILED' %}
              <div class="p-4 bg-red-50 rounded-lg border border-red-300">
                <h3 class="font-semibold text-lg text-red-800 mb-2">❌ 失败</h3>
                <p class="mb-2 text-sm text-red-700">任务执行失败，错误信息如下：</p>
                <pre class="text-sm bg-white p-2 rounded border overflow-auto">{{ project.cloud_reasoning_error|default:"没有可用的错误信息。" }}</pre>
              </div>

            {# --- 状态 5: PROCESSING (处理中) --- #}
            {% elif project.cloud_reasoning_status != 'PENDING' %}
              <div class="p-4 bg-blue-50 rounded-lg border border-blue-300">
                <h3 class="font-semibold text-lg text-blue-800 mb-2">⚙️ 处理中...</h3>
                <p class="text-sm text-blue-700 mb-3" id="status-display-text">
                  当前状态: <strong>{{ project.get_cloud_reasoning_status_display }}</strong>.
                  {# [IMPROVEMENT] 更新了提示文本 #}
                  页面将在 5 秒后自动刷新...
                </p>
                <div id="loading-spinner" class="flex items-center space-x-2 text-sm text-blue-600">
                    <svg class="animate-spin h-4 w-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>正在获取最新状态...</span>
                </div>
              </div>

            {# --- 状态 6: 无法启动 (缺少蓝图) --- #}
            {% elif not project.final_blueprint_file %}
              <div class="p-4 bg-gray-50 rounded-lg border">
                <p class="text-sm text-gray-600">
                  无法启动：本地 `final_blueprint_file` 未找到。
                  请返回项目详情页，确保“最终叙事蓝图(JSON)”已成功生成。
                </p>
              </div>
            {% endif %}

          {% endwith %}
        </div>
    </fieldset>
</div>
{% endblock %}


{% block extrajs %}
    {{ block.super }}
    <script>
    (function() {
        // 从 Django 模板获取当前状态
        const currentStatus = "{{ original.cloud_reasoning_status|escapejs }}";

        // 定义哪些状态是 "处理中" 状态，需要自动刷新
        //
        const processingStates = [
            'BLUEPRINT_UPLOADING',
            'METRICS_RUNNING',
            'FACTS_RUNNING',
            'PIPELINE_RUNNING',
            'RAG_DEPLOYING'
        ];

        if (processingStates.includes(currentStatus)) {
            // 如果是处理中状态, 5秒后自动刷新页面
            console.log(`Current status is ${currentStatus}. Refreshing in 5 seconds...`);
            setTimeout(() => {
                window.location.reload();
            }, 5000); // 5000 毫秒 = 5 秒
        }
    })();
    </script>
{% endblock %}