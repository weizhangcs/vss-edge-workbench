{% extends "admin/change_form.html" %}
{% load i18n admin_urls static %}

{% block after_field_sets %}

{# 1. 数据构造 #}
<script>
    window.SERVER_CONTEXT = {
        statusOptions: [
            {% for s, d in status_choices %}["{{ s }}", "{{ d }}"],{% endfor %}
        ],
        filter: {
            active: "{{ l2l3_active_filter|default:'' }}"
        },
        pagination: {
            current: {{ l2l3_page_obj.number }},
            total: {{ l2l3_page_obj.paginator.count }},
            pageSize: 10,
            totalPages: {{ l2l3_page_obj.paginator.num_pages }}
        },
        items: [
            {% for item in l2l3_media_items_with_status %}
            {
                "id": "{{ item.media.id }}",
                "sequence": "{{ item.media.sequence_number }}",
                "title": "{{ item.media.title|escapejs }}",
                "status": "{% if item.l2l3_job %}{{ item.l2l3_job.status }}{% else %}NOT_CREATED{% endif %}",
                "statusDisplay": "{% if item.l2l3_job %}{{ item.l2l3_job.get_status_display }}{% else %}未创建{% endif %}",
                "created": "{% if item.l2l3_job %}{{ item.l2l3_job.created|date:'Y-m-d H:i' }}{% else %}--{% endif %}",
                "modified": "{% if item.l2l3_job %}{{ item.l2l3_job.modified|date:'Y-m-d H:i' }}{% else %}--{% endif %}",

                "actionUrl": "{% if item.l2l3_job %}{% url 'workflow:annotation_job_start_l2l3' item.l2l3_job.id %}{% endif %}",
                "actionText": "▶️ 进入场景标注",
                "isRevision": false
            },
            {% endfor %}
        ]
    };
</script>

{# 2. 挂载点 #}
<div id="react-root-l2" class="mt-6 bg-white min-h-[400px]">
    <div class="text-center pt-20">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
    </div>
</div>

{# 3. 引用 JS #}
<script type="module" src="{% static 'js/bundles/annotation-scene.js' %}"></script>

{% endblock %}