{% extends "admin/change_form.html" %}
{% load i18n admin_urls unfold %}

{% block field_sets %}
{# --- ä¸ŠåŠéƒ¨åˆ†ï¼šå·¦å³åˆ†åŒº --- #}
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 p-8">
  {% for fieldset in adminform %}
    {% if forloop.first %}
      {# --- å·¦ä¾§ï¼šé¡¹ç›®ä¿¡æ¯ --- #}
      <div class="col-span-1 border-r pr-8">
        {% include "admin/includes/fieldset.html" %}
      </div>
    {% elif forloop.last %}
      {# --- å³ä¾§ï¼šé¡¹ç›®çº§äº§å‡ºç‰© (ç°åœ¨ç”±FormåŠ¨æ€æ¸²æŸ“æŒ‰é’®) --- #}
      <div class="col-span-1 lg:mt-0">
        {% include "admin/includes/fieldset.html" %}
      </div>
    {% endif %}
  {% endfor %}
</div>

{# --- ä¸‹åŠéƒ¨åˆ†ï¼šèµ„äº§åˆ—è¡¨ --- #}
<div class="p-8 pt-0">
  <fieldset class="module aligned">
    <h2 class="text-xl font-semibold mb-4">èµ„äº§åˆ—è¡¨ (Asset-level Operations)</h2>

    <div class="mb-4 p-4 bg-gray-50 rounded-md border">
        <div class="flex items-center space-x-4">
            <strong class="text-sm font-medium">æŒ‰L1çŠ¶æ€è¿‡æ»¤:</strong>
            <a href="?" class="text-sm px-2 py-1 rounded-md {% if not active_filters.l1_status %}bg-blue-600 text-white{% else %}bg-gray-200 hover:bg-gray-300{% endif %}">å…¨éƒ¨</a>
            {% for status, display in status_choices %}
                <a href="?l1_status={{ status }}" class="text-sm px-2 py-1 rounded-md {% if active_filters.l1_status == status %}bg-blue-600 text-white{% else %}bg-gray-200 hover:bg-gray-300{% endif %}">{{ display }}</a>
            {% endfor %}
        </div>
        <div class="flex items-center space-x-4 mt-2">
            <strong class="text-sm font-medium">æŒ‰L2çŠ¶æ€è¿‡æ»¤:</strong>
            <a href="?" class="text-sm px-2 py-1 rounded-md {% if not active_filters.l2l3_status %}bg-blue-600 text-white{% else %}bg-gray-200 hover:bg-gray-300{% endif %}">å…¨éƒ¨</a>
            {% for status, display in status_choices %}
                <a href="?l2l3_status={{ status }}" class="text-sm px-2 py-1 rounded-md {% if active_filters.l2l3_status == status %}bg-blue-600 text-white{% else %}bg-gray-200 hover:bg-gray-300{% endif %}">{{ display }}</a>
            {% endfor %}
        </div>
    </div>

    <div class="overflow-x-auto">
      <table id="asset-list-table" class="min-w-full bg-white border border-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="py-2 px-4 border-b border-r" rowspan="2">åºå·</th>
            <th class="py-2 px-4 border-b border-r" rowspan="2">èµ„äº§æ ‡é¢˜</th>
            <th class="py-2 px-4 border-b border-r text-center" colspan="3">å­—å¹•æ ‡æ³¨ (L1)</th>
            <th class="py-2 px-4 border-b border-r text-center" colspan="3">è¯­ä¹‰æ ‡æ³¨ (L2/L3)</th>
            <th class="py-2 px-4 border-b" rowspan="2">æ“ä½œ</th>
          </tr>
          <tr>
            <th class="py-2 px-4 border-b border-r font-medium">çŠ¶æ€</th>
            <th class="py-2 px-4 border-b border-r font-medium">åˆ›å»ºæ—¶é—´</th>
            <th class="py-2 px-4 border-b border-r font-medium">æ›´æ–°æ—¶é—´</th>
            <th class="py-2 px-4 border-b border-r font-medium">çŠ¶æ€</th>
            <th class="py-2 px-4 border-b border-r font-medium">åˆ›å»ºæ—¶é—´</th>
            <th class="py-2 px-4 border-b border-r font-medium">æ›´æ–°æ—¶é—´</th>
          </tr>
        </thead>
        <tbody>
          {% if media_items_with_status %}
            {% for item in media_items_with_status %}
              <tr class="hover:bg-gray-100">
                <td class="py-2 px-4 border-b border-r">{{ item.media.sequence_number }}</td>
                <td class="py-2 px-4 border-b border-r">{{ item.media.title }}</td>
                <td class="py-2 px-4 border-b border-r">{% if item.l1_job %}{{ item.l1_job.get_status_display }}{% else %}æœªåˆ›å»º{% endif %}</td>
                <td class="py-2 px-4 border-b border-r">{% if item.l1_job %}{{ item.l1_job.created|date:"Y-m-d H:i" }}{% else %}--{% endif %}</td>
                <td class="py-2 px-4 border-b border-r">{% if item.l1_job %}{{ item.l1_job.modified|date:"Y-m-d H:i" }}{% else %}--{% endif %}</td>
                <td class="py-2 px-4 border-b border-r">{% if item.l2l3_job %}{{ item.l2l3_job.get_status_display }}{% else %}æœªåˆ›å»º{% endif %}</td>
                <td class="py-2 px-4 border-b border-r">{% if item.l2l3_job %}{{ item.l2l3_job.created|date:"Y-m-d H:i" }}{% else %}--{% endif %}</td>
                <td class="py-2 px-4 border-b border-r">{% if item.l2l3_job %}{{ item.l2l3_job.modified|date:"Y-m-d H:i" }}{% else %}--{% endif %}</td>
                <td class="py-2 px-4 border-b" colspan="2">
                  <div class="flex items-center space-x-2">
                    {% if item.l1_job %}
                       {% if item.l1_job.l1_output_file %}
                           <a href="{% url 'workflow:annotation_job_revise_l1' item.l1_job.id %}" class="button" target="_blank">ğŸ” ä¿®è®¢å­—å¹•æ ‡æ³¨</a>
                       {% else %}
                           <a href="{% url 'workflow:annotation_job_start_l1' item.l1_job.id %}" class="button" target="_blank">â–¶ï¸ å¼€å§‹å­—å¹•æ ‡æ³¨</a>
                       {% endif %}
                    {% endif %}
                    {% if item.l2l3_job %}
                       <a href="{% url 'workflow:annotation_job_start_l2l3' item.l2l3_job.id %}" class="button" target="_blank">â–¶ï¸ è¿›å…¥è¯­ä¹‰æ ‡æ³¨</a>
                    {% endif %}
                  </div>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="9" class="py-4 px-4 text-center text-gray-500">æ­¤é¡¹ç›®å…³è”çš„èµ„äº§ä¸‹æ²¡æœ‰æ‰¾åˆ°ä»»ä½•åª’ä½“æ–‡ä»¶ã€‚</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    {% if page_obj.paginator.num_pages > 1 %}
      <div class="pagination flex items-center justify-between mt-4 p-4 border-t">
        <span class="text-sm text-gray-700">
          ç¬¬ {{ page_obj.number }} é¡µ / å…± {{ page_obj.paginator.num_pages }} é¡µ (å…± {{ page_obj.paginator.count }} æ¡)
        </span>
        <div class="flex items-center space-x-1">
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if active_filters.l1_status %}&l1_status={{ active_filters.l1_status }}{% endif %}{% if active_filters.l2l3_status %}&l2l3_status={{ active_filters.l2l3_status }}{% endif %}" class="px-3 py-1 text-sm bg-gray-200 rounded-md hover:bg-gray-300">ä¸Šä¸€é¡µ</a>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <span class="px-3 py-1 text-sm bg-blue-600 text-white rounded-md">{{ num }}</span>
            {% else %}
              <a href="?page={{ num }}{% if active_filters.l1_status %}&l1_status={{ active_filters.l1_status }}{% endif %}{% if active_filters.l2l3_status %}&l2l3_status={{ active_filters.l2l3_status }}{% endif %}" class="px-3 py-1 text-sm bg-gray-200 rounded-md hover:bg-gray-300">{{ num }}</a>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if active_filters.l1_status %}&l1_status={{ active_filters.l1_status }}{% endif %}{% if active_filters.l2l3_status %}&l2l3_status={{ active_filters.l2l3_status }}{% endif %}" class="px-3 py-1 text-sm bg-gray-200 rounded-md hover:bg-gray-300">ä¸‹ä¸€é¡µ</a>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </fieldset>
</div>
{% endblock %}

{% comment %}
--- è¿™æ˜¯æ–°å¢çš„ JS å—ï¼Œç²˜è´´åœ¨æ–‡ä»¶çš„æœ€æœ«å°¾ ---
{% endcomment %}

{% block extrajs %}
    {# 1. å¿…é¡»è°ƒç”¨ superï¼Œä¿ç•™ Django å’Œ Unfold çš„é»˜è®¤ JS #}
    {{ block.super }}

    <script>
    document.addEventListener('DOMContentLoaded', (event) => {

        // 2. æŸ¥æ‰¾æˆ‘ä»¬åˆšåˆšåœ¨ widgets.py ä¸­æ·»åŠ çš„æŒ‰é’® class
        const triggerButton = document.querySelector('.js-cloud-trigger-btn');

        // 3. ä» Django ä¸Šä¸‹æ–‡è·å– object_id (UUID)
        const objectId = '{{ object_id|escapejs }}';

        if (triggerButton && objectId && objectId !== 'None') {

            let triggerUrl;
            let workflowUrl;

            try {
                // 4. [å·²ä¿®æ­£] ä½¿ç”¨ 'workflow:' å‘½åç©ºé—´ (æ¥è‡ª urls.py å’Œ admin.py)

                // å¯¹åº” urls.py ä¸­çš„: path('.../trigger-cloud-pipeline/', ...)
                triggerUrl = '{% url "workflow:annotation_project_trigger_cloud_pipeline" project_id=object_id %}';

                // å¯¹åº” urls.py å’Œ admin.py ä¸­çš„: path('.../reasoning-workflow/', ...)
                workflowUrl = '{% url "workflow:annotation_project_reasoning_workflow" project_id=object_id %}';

            } catch (e) {
                console.error("æ— æ³•åœ¨ Django æ¨¡æ¿ä¸­è§£æ URLã€‚è¯·æ£€æŸ¥ 'workflow:...' URL åç§°æ˜¯å¦æ­£ç¡®ã€‚", e);
                return;
            }

            // 5. æ ¸å¿ƒï¼šä¸ºæŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
            triggerButton.addEventListener('click', function(e) {
                // é˜»æ­¢æŒ‰é’®çš„é»˜è®¤ <a href> è·³è½¬è¡Œä¸º
                e.preventDefault();

                console.log('Triggering task for project:', objectId);

                const originalText = this.textContent;
                this.textContent = 'æ­£åœ¨å¯åŠ¨...';
                this.disabled = true;

                // 6. æ­¥éª¤ A: å¼‚æ­¥è§¦å‘åç«¯ä»»åŠ¡
                fetch(triggerUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message || 'å¯åŠ¨ä»»åŠ¡å¤±è´¥ã€‚') });
                    }
                    return response.json();
                })
                .then(data => {
                    // (æ‚¨çš„ trigger è§†å›¾ç›®å‰æ˜¯é‡å®šå‘ï¼Œä½†å¦‚æœå®ƒè¿”å› JSON ä¼šæ›´å¥½)
                    // æˆ‘ä»¬æš‚æ—¶å‡è®¾ 200 OK å°±æ„å‘³ç€æˆåŠŸ
                    if (data.status === 'success' || data.task_id || response.ok) {

                        // 7. æ­¥éª¤ B: ä»»åŠ¡å¯åŠ¨æˆåŠŸï¼Œæ‰“å¼€æ–°çª—å£
                        console.log('ä»»åŠ¡å¯åŠ¨æˆåŠŸ, æ­£åœ¨æ‰“å¼€å·¥ä½œæµé¡µé¢:', workflowUrl);
                        window.open(workflowUrl, '_blank');

                        this.textContent = 'ä»»åŠ¡å·²å¯åŠ¨!';
                        setTimeout(() => {
                            this.textContent = originalText;
                            this.disabled = false;
                        }, 2000);

                    } else {
                        throw new Error(data.message || 'ä»åç«¯æ”¶åˆ°äº†æœªçŸ¥çš„å“åº”');
                    }
                })
                .catch(error => {
                    // 8. é”™è¯¯å¤„ç†
                    console.error('è§¦å‘äº‘ç«¯ä»»åŠ¡æ—¶å‡ºé”™:', error);
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å› ä¸º fetch æœŸæœ› JSON ä½†æ”¶åˆ°äº†é‡å®šå‘
                    if (error.name === 'SyntaxError') {
                        console.warn('Fetch æ•è·åˆ° SyntaxErrorï¼Œè¿™å¯èƒ½æ˜¯å› ä¸ºåç«¯è§†å›¾è¿”å›äº†é‡å®šå‘(Redirect)è€Œä¸æ˜¯ JSONã€‚æ­£åœ¨æŒ‰æˆåŠŸå¤„ç†...');

                        // [ä¸´æ—¶å¤„ç†]ï¼šå¦‚æœæ˜¯å› ä¸ºåç«¯é‡å®šå‘å¯¼è‡´ JSON è§£æå¤±è´¥ï¼Œæˆ‘ä»¬ä»è®¤ä¸ºå¯åŠ¨æˆåŠŸ
                        console.log('ä»»åŠ¡å¯åŠ¨æˆåŠŸ (å‡å®š), æ­£åœ¨æ‰“å¼€å·¥ä½œæµé¡µé¢:', workflowUrl);
                        window.open(workflowUrl, '_blank');
                        this.textContent = 'ä»»åŠ¡å·²å¯åŠ¨!';
                        setTimeout(() => {
                            this.textContent = originalText;
                            this.disabled = false;
                        }, 2000);

                    } else {
                        alert('é”™è¯¯: ' + error.message);
                        this.textContent = originalText;
                        this.disabled = false;
                    }
                });
            });

        } else {
            // è°ƒè¯•
            if (!triggerButton) {
                console.warn('Admin JS: æœªæ‰¾åˆ°äº‘ç«¯è§¦å‘æŒ‰é’® (.js-cloud-trigger-btn)ã€‚è¯·æ£€æŸ¥æ‚¨çš„ widget.py æ˜¯å¦å·²ä¿®æ”¹ã€‚');
            }
            if (!objectId || objectId === 'None') {
                console.warn('Admin JS: æœªæ‰¾åˆ° object_id (è¿™åœ¨ "Add" é¡µé¢æ˜¯æ­£å¸¸çš„)ã€‚');
            }
        }
    });
    </script>
{% endblock %}